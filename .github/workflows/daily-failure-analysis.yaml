name: Daily Failure Analysis

on:
  schedule:
    # Run at 3:00 PM UTC, after quarkus-test-suite daily builds finish
    # (daily builds start at ~6:00 AM UTC and take 8-9 hours)
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      run_url:
        description: 'Specific run URL to analyze (optional, defaults to latest daily.yaml run). Example: https://github.com/quarkus-qe/quarkus-test-suite/actions/runs/20946183562'
        required: false
        type: string
      from:
        description: 'Reference date to look back from (format: dd.MM.yyyy or yyyy-MM-dd). Defaults to: run date if run_url provided, otherwise today'
        required: false
        type: string
      lookback_days:
        description: 'Number of days to look back for upstream changes'
        required: false
        type: string
        default: '2'

permissions:
  contents: read
  actions: read

jobs:
  analyze-failures:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Reclaim Disk Space
      run: |
        echo "Reclaiming disk space for Quarkus builds during bisect..."
        df -h /

        # Remove large unused tools to free ~32 GB
        sudo docker image prune --all --force || true
        sudo rm -rf /usr/share/swift /usr/share/gradle-* /usr/share/miniconda
        sudo rm -rf /opt/az /opt/google /opt/microsoft /opt/pipx
        sudo rm -rf /usr/local/lib/android /usr/local/julia* /usr/local/.ghcup /usr/local/share/powershell /usr/lib/google-cloud-sdk
        sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/PyPy /opt/hostedtoolcache/Python /opt/hostedtoolcache/Ruby /opt/hostedtoolcache/go /opt/hostedtoolcache/node

        echo "Disk space after cleanup:"
        df -h /

    - name: Install JDK 21
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: 21
        check-latest: true
        cache: 'maven'

    - name: Set up Maven settings.xml
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << 'EOF'
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <profiles>
                <profile>
                    <id>google-mirror</id>
                    <repositories>
                        <repository>
                            <id>google-maven-central</id>
                            <name>GCS Maven Central mirror</name>
                            <url>https://maven-central.storage-download.googleapis.com/maven2/</url>
                            <releases><enabled>true</enabled></releases>
                            <snapshots><enabled>false</enabled></snapshots>
                        </repository>
                    </repositories>
                    <pluginRepositories>
                        <pluginRepository>
                            <id>google-maven-central</id>
                            <name>GCS Maven Central mirror</name>
                            <url>https://maven-central.storage-download.googleapis.com/maven2/</url>
                            <releases><enabled>true</enabled></releases>
                            <snapshots><enabled>false</enabled></snapshots>
                        </pluginRepository>
                    </pluginRepositories>
                </profile>
                <profile>
                    <id>quarkus-snapshots</id>
                    <repositories>
                        <repository>
                            <id>quarkus-snapshots-repository</id>
                            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
                            <releases><enabled>false</enabled></releases>
                            <snapshots><enabled>true</enabled></snapshots>
                        </repository>
                    </repositories>
                    <pluginRepositories>
                        <pluginRepository>
                            <id>quarkus-snapshots-plugin-repository</id>
                            <url>https://central.sonatype.com/repository/maven-snapshots/</url>
                            <releases><enabled>false</enabled></releases>
                            <snapshots><enabled>true</enabled></snapshots>
                        </pluginRepository>
                    </pluginRepositories>
                </profile>
            </profiles>
            <activeProfiles>
                <activeProfile>google-mirror</activeProfile>
                <activeProfile>quarkus-snapshots</activeProfile>
            </activeProfiles>
        </settings>
        EOF

    - name: Download and install Quarkus CLI
      run: |
        echo "Downloading Quarkus CLI 999-SNAPSHOT..."
        mvn org.apache.maven.plugins:maven-dependency-plugin:get -Dartifact=io.quarkus:quarkus-cli:999-SNAPSHOT:jar:runner

        cat > ./quarkus-dev-cli << 'EOF'
        #!/bin/bash
        java -jar ~/.m2/repository/io/quarkus/quarkus-cli/999-SNAPSHOT/quarkus-cli-999-SNAPSHOT-runner.jar "$@"
        EOF
        chmod +x ./quarkus-dev-cli
        ./quarkus-dev-cli version

    - name: Configure Docker mirror
      run: |
        cat > ./daemon.json << 'EOF'
        {
          "registry-mirrors": ["https://mirror.gcr.io", "https://public.ecr.aws/docker"]
        }
        EOF
        sudo cp ./daemon.json /etc/docker/daemon.json
        sudo systemctl restart docker

        # Verify mirrors are configured
        docker info | grep -A 5 "Registry Mirrors"

    - name: Download latest native executable
      run: |
        echo "Downloading latest release native executable for Linux x86_64..."
        gh release download --repo quarkus-qe/test-failure-detector \
          --pattern 'test-failure-detector-linux-x86_64' \
          --output test-failure-detector

        chmod +x test-failure-detector
        echo "Downloaded and made executable"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Download previous history file
      continue-on-error: true
      run: |
        echo "Attempting to download history from previous run..."

        # Get the most recent successful run of this workflow
        PREVIOUS_RUN=$(gh run list \
          --workflow=daily-failure-analysis.yaml \
          --status=success \
          --limit=1 \
          --json databaseId \
          --jq '.[0].databaseId')

        if [ -z "$PREVIOUS_RUN" ]; then
          echo "No previous successful run found, starting fresh"
          exit 0
        fi

        echo "Found previous run: $PREVIOUS_RUN"

        # Download the history artifact from that run
        gh run download "$PREVIOUS_RUN" \
          --name failure-analysis-history \
          --dir . || {
          echo "Failed to download history artifact, starting fresh"
          exit 0
        }

        if [ -f failure-history.json ]; then
          echo "Successfully downloaded history file"
        else
          echo "History file not found in artifact"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run failure analysis
      run: |
        # Use the downloaded executable
        EXECUTABLE="./test-failure-detector"

        # Determine target URL (specific run or latest workflow run)
        if [ -n "${{ inputs.run_url }}" ]; then
          TARGET_URL="${{ inputs.run_url }}"
          echo "Analyzing specific run: $TARGET_URL"

          # Extract run ID from URL
          RUN_ID=$(echo "$TARGET_URL" | sed -E 's|.*/runs/([0-9]+).*|\1|')

          # Get run date if 'from' not explicitly provided
          if [ -z "${{ inputs.from }}" ]; then
            echo "Fetching run date for run ID: $RUN_ID"
            RUN_DATE=$(gh api "repos/quarkus-qe/quarkus-test-suite/actions/runs/$RUN_ID" --jq '.created_at')
            # Convert ISO date to dd.MM.yyyy format
            FROM_DATE=$(date -d "$RUN_DATE" +%d.%m.%Y)
            echo "Using run date as 'from': $FROM_DATE"
          else
            FROM_DATE="${{ inputs.from }}"
            echo "Using explicitly provided from date: $FROM_DATE"
          fi
        else
          TARGET_URL="https://github.com/quarkus-qe/quarkus-test-suite/actions/workflows/daily.yaml"
          FROM_DATE="${{ inputs.from }}"
          echo "Analyzing latest workflow run: $TARGET_URL"
        fi

        # Build command arguments
        ARGS="GITHUB_ACTION_ARTIFACTS $TARGET_URL"

        # Add history file if it exists from previous run
        if [ -f failure-history.json ]; then
          echo "Found previous history file, using it for continuity"
          ARGS="$ARGS --history-file=failure-history.json"
        else
          echo "No previous history file found, starting fresh"
        fi

        # Add lookback days (default: 2)
        LOOKBACK="${{ inputs.lookback_days || '2' }}"
        ARGS="$ARGS --lookback-days=$LOOKBACK"

        # Add from date if set
        if [ -n "$FROM_DATE" ]; then
          echo "Using from date: $FROM_DATE"
          ARGS="$ARGS --from=$FROM_DATE"
        fi

        # Add output file
        ARGS="$ARGS --output-file=failure-report.txt"

        echo "Running: $EXECUTABLE $ARGS"

        # Run the tool (don't fail workflow if tool exits with error)
        $EXECUTABLE $ARGS || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Display report summary
      if: always()
      run: |
        if [ -f failure-report.txt ]; then
          echo "=== Failure Analysis Report ==="
          head -50 failure-report.txt
          echo ""
          echo "(Full report available in artifacts)"
        else
          echo "No report generated"
        fi

    - name: Upload failure report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: failure-analysis-report-${{ github.run_number }}
        path: failure-report.txt
        retention-days: 30
        if-no-files-found: warn

    - name: Upload history file
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('failure-history.json') != ''
      with:
        name: failure-analysis-history
        path: failure-history.json
        retention-days: 30
